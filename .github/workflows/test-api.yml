name: Test Claude API
on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test:
    if: contains(github.event.issue.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - name: Test API Key
        run: |
          echo "Testing Anthropic API connection..."
          response=$(curl -s -w "\n%{http_code}" https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 100,
              "messages": [{"role": "user", "content": "Say hello"}]
            }')
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          if [ "$http_code" = "200" ]; then
            echo "✅ API key is valid!"
          else
            echo "❌ API key test failed"
            exit 1
          fi
      
      - name: Comment on Issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ API key works! Claude Code should be able to connect.'
            })
